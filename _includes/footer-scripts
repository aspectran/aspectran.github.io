<script src="{{ site.baseurl }}/assets/js/foundation.min.js"></script>
<script src="{{ site.baseurl }}/assets/js/jquery.backstretch.js"></script>
<script>
  $(document).foundation();
  $(document).ready(function() {
    var $win = $(window);
    var $nav = $("#navigation");
    var navHeight = $("#masthead").height() - $nav.height();
    var lastScrollTop = 0;
    var scrolled;
    var navFixed;
    $win.scroll(function() {
      scrolled = true;
    });
    setInterval(function() {
      if (scrolled) {
        var scrollTop = $win.scrollTop();
        if (Math.abs(lastScrollTop - scrollTop) <= 10) {
          return;
        }
        if (scrollTop <= navHeight) {
          if (navFixed) {
            $nav.removeClass("fixed");
            navFixed = false;
          }
        } else if (scrollTop > lastScrollTop) {
          if (navFixed) {
            $nav.removeClass("fixed");
            navFixed = false;
          }
        } else {
          if (!navFixed) {
            $nav.addClass("fixed");
            $nav.hide().fadeIn(500);
            navFixed = true;
          }
        }
        lastScrollTop = scrollTop;
        scrolled = false;
      }
    }, 200);
    /* google search */
    $("form[name=google_quick_search]").submit(function(event) {
      window.open('https://www.google.com/search?q=' + this.keyword.value + '+site:{{ site.url | cgi_escape }}');
      event.preventDefault();
    });
  });
</script>

{% if page.sidebar == "toc" %}
<script>
  $(document).ready(function() {
    $("#masthead h1, article h1, article h2, article h3, article h4, article h5, article h6").each(function(index, item) {
      var tagn = item.localName;
      var anchor = "top-of-page";
      if(tagn != "h1") {
        anchor = "anchor-" + (index + 1);
        $(this).before("<a class='toc-anchor " + anchor + "' id='" + anchor + "' name='" + anchor + "'></a>");
      }
      $("#toc ul").append("<li class='toc-" + tagn + "'><a anchor='" + anchor + "' href='#" + anchor + "'>" + $(item).text() + "</a></li>");
    });
  });
</script>
{% endif %}

{% if page.sidebar %}
<script>
  $(document).ready(function() {
    $(".lazy-sticky").each(function() {
      var $win = $(window);
      var $this = $(this);
      var upToTopHeight = $("#up-to-top").height() + 30 + 60;
      var footerHeight = $("#footer-content").height() + upToTopHeight;
      var baseOffsetTop = $this.offset().top;
      var offsetTop = 0;
      var thisHeight = $this.height();
      var winHeight = $win.height();
      var scrollTimer = null;
      var immediate = false;
      $this.find("#toc ul a").click(function(e) {
        immediate = true;
        var anchor = $(this).attr("anchor");
        if(anchor != "top-of-page") {
          setTimeout(function() {
            var offset = $("#" + anchor).offset();
            if(offset) {
              immediate = true;
              $win.scrollTop(offset.top - $("#navigation.fixed .top-bar").height()||0);
            }
          }, 300);
        }
      });
      $win.scroll(function() {
        var scrollTop = $win.scrollTop();
        if(scrollTop < baseOffsetTop) {
          if(scrollTimer) {
            clearInterval(scrollTimer);
            scrollTimer = null;
          }
          scrollTimer = setInterval(function() {
            if(offsetTop != 0) {
              $this.css({
                top: 0
              });
            }
            offsetTop = 0;
            clearInterval(scrollTimer);
            scrollTimer = null;
            immediate = false;
          }, immediate ? 250 : 500);
        } else {
          var topBarHeight = $("#navigation.fixed .top-bar").height()||0;
          if(immediate || (scrollTop > baseOffsetTop + topBarHeight + offsetTop + thisHeight - 20) || 
              (scrollTop < baseOffsetTop + topBarHeight + offsetTop)) {
            var tocOffsetLeftBase = $this.offset().left;
            if(tocOffsetLeftBase > 100) {
              if(scrollTimer) {
                clearInterval(scrollTimer);
                scrollTimer = null;
              }
              scrollTimer = setInterval(function() {
                topBarHeight = $("#navigation.fixed .top-bar").height()||0;
                scrollTop = $win.scrollTop();
                if(scrollTop < baseOffsetTop + topBarHeight) {
                  scrollTop = 0;
                } else {
                  scrollTop = scrollTop - baseOffsetTop + topBarHeight + 10;
                }
                if(scrollTop > $(document).height() - footerHeight - thisHeight - baseOffsetTop + topBarHeight) {
                  scrollTop = $(document).height() - footerHeight - thisHeight - baseOffsetTop + topBarHeight;
                }
                offsetTop = scrollTop;
                $this.css({
                  position: "relative"
                });
                $this.animate({
                  top: scrollTop + "px"
                }, 300);
                clearInterval(scrollTimer);
                scrollTimer = null;
                winHeight = $win.height();
                thisHeight = $this.height();
                footerHeight = $("#footer-content").height() + upToTopHeight;
                immediate = false;
              }, immediate ? 250 : 500);
            }
          }
        }
      });
      $win.resize(function() {
        var tocOffsetLeftBase = $this.offset().left;
        if(tocOffsetLeftBase <= 100) {
          clearInterval(scrollTimer);
          $this.css("top", 0);
        } else {
          $win.scroll();
        }
      });
      setTimeout(function() {
        if($win.scrollTop() > baseOffsetTop) {
          offsetTop = $win.scrollTop();
          $win.scroll();
        }
      }, 150);
    });
  });
</script>
{% endif %}

{% if page.header.image_fullwidth %}
<script>
  $("#masthead").backstretch("{{ site.urlimg }}{{ page.header.image_fullwidth }}", {fade: 900, bgcolor: '#2A2E31'});
</script>
{% endif %}
{% if page.header.slide_images and page.header.slide_images[0] %}
<script>
  $("#masthead").backstretch([
    "{{ site.urlimg }}{{ page.header.slide_images[0] }}"
  {% for image in page.header.slide_images %}
  {% if forloop.index > 1 %}, "{{ site.urlimg }}{{ image }}"{% endif %}
  {% endfor %}
  ], {duration: 3300, fade: 900, bgcolor: '#445259'}});
</script>
{% endif %}

<script>
  /* Creating custom :external selector */
  $.expr[':'].external = function(obj) {
    return !obj.href.match(/^javascript\:/)
            && !obj.href.match(/^mailto\:/)
            && (obj.hostname != location.hostname);
  };
  $(function(){
    /* Add 'external' CSS class to all external links */
    $('a:external').addClass('external');
    /* turn target into target=_blank for elements w external class */
    $(".external").attr('target','_blank');
  })
</script>

{% comment %}
#  Start of Tawk.to Script
#
#  More information in _config.yml
#
{% endcomment %}
{% if site.tawkto_embed_uri and page.tawkto == true %}
<script type="text/javascript">
  var $_Tawk_API={},$_Tawk_LoadStart=new Date();
  (function(){
  var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
  s1.async=true;
  s1.src='{{ site.tawkto_embed_uri }}';
  s1.charset='UTF-8';
  s1.setAttribute('crossorigin','*');
  s0.parentNode.insertBefore(s1,s0);
  })();
</script>
{% endif %}

{% if site.google_translate_website == true %}
{% include google-translate-website %}
{% endif %}
